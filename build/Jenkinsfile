#!/usr/bin/env groovy

NS='remediations-pr'

def scale (count) {
    sh "oc scale --replicas=${count} --namespace=${NS} dc/postgres"
    sh "oc scale --replicas=${count} --namespace=${NS} dc/playbooks-cac"
    sh "oc scale --replicas=${count} --namespace=${NS} dc/playbooks-ssg"

    // wait for dependencies
    waitFor(count, 'postgres')
    waitFor(count, 'playbooks-cac')
    waitFor(count, 'playbooks-ssg')
}

def waitFor (count, resource) {
    println "waiting for ${resource} to scale to ${count}"

    openshift.withCluster() {
        openshift.withProject(NS) {
            timeout(2) {
                def latestDeploymentVersion = openshift.selector('dc', resource).object().status.latestVersion
                def rc = openshift.selector('rc', "${resource}-${latestDeploymentVersion}")
                rc.untilEach(1) {
                    def rcMap = it.object()
                    def ready = rcMap.status.readyReplicas == null ? 0 : rcMap.status.readyReplicas
                    return (rcMap.status.replicas.equals(ready))
                }
            }
        }
    }
}

node {
    env.NODEJS_HOME = "${tool 'node-10'}"
    env.PATH="${env.NODEJS_HOME}/bin:${env.PATH}"

    checkout scm

    sh 'git rev-parse HEAD'

    stage('build') {
        sh 'npm ci'
    }

    stage('verify') {
        env.DB_HOST="postgres.${NS}.svc"
        env.DB_DATABASE='remediationstest'
        env.CAC_IMPL='impl'
        env.CAC_HOST="http://playbooks-cac.${NS}.svc:8080"
        env.SSG_IMPL='impl'
        env.SSG_HOST="http://playbooks-ssg.${NS}.svc:8080"

        lock(NS) {
            scale(1)
            sh "oc get pods --namespace ${NS}"

            try {
                sh 'npm run verify'
                sh 'npm run db:migrate'
                sh 'npm run db:migrate:undo:all'
            } finally {
                scale(0)
                sh "oc get pods --namespace ${NS}"
            }
        }
    }
}
